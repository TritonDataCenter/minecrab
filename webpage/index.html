<html>
<head>
<link href='minecrab.css' rel='stylesheet' type='text/css'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
<script type="text/javascript">
  var manta = document.location.protocol + '//' + document.location.hostname;
  var page = document.location.pathname;
  var user = page.split('/')[1];
  var servers_loc = manta + '/' + user + '/public/minecrab/servers/';
  var difficulty = ['Peaceful', 'Easy', 'Normal', 'Hard']
  var gamemode = ['Survival', 'Creative', 'Adventure']

  function findIp(name, cb) {
      var user = page.split('/')[1];
      var url = servers_loc + name + '/ip';
      $.ajax({
          'url': url,
          'success': cb,
          'error': function () {
              cb(null);
          }
      });
  }

  function parseProperties(propData) {
      var props = {};
      if (propData === null) {
          return (props);
      }
      var propLines = propData.split('\n');
      propData.split('\n').forEach(function (dl) {
          if (dl === null || dl === '' || dl.slice(0, 1) === '#') {
              return;
          }
          var parts = dl.split('=');
          parts[1] = parts[1].replace(/"/g, '');  //" Fixes syntax highlighting
          props[parts[0]] = parts[1];
      });
      return (props);
  }

  function findConfig(name, cb) {
      var user = page.split('/')[1];
      var url = servers_loc + name + '/server/server.config';
      function onSuccess(data) {
          cb(parseProperties(data));
      }
      $.ajax({
          'url': url,
          'success': onSuccess,
          'error': function () {
              cb(null);
          }
      });
  }

  function findProperties(name, cb) {
      var user = page.split('/')[1];
      var url = servers_loc + name + '/server/server.properties';
      function onSuccess(data) {
          cb(parseProperties(data));
      }
      $.ajax({
          'url': url,
          'success': onSuccess,
          'error': function () {
              cb(null);
          }
      });
  }

  function worldDetails(name, cb) {
      var res = {};
      findIp(name, function (ip) {
          findConfig(name, function (cfg) {
              findProperties(name, function (props) {
                  var status = ip ? 'Online' : 'Offline';
                  var params = {
                      name: name,
                      ip: ip,
                      status: status,
                      map_index: servers_loc + name + '/map/view/index.html',
                      thumbnail: servers_loc + name + '/map/view/render1/base.png',
                      version: cfg === null ? 'unknown' : cfg['MINECRAFT_VERSION'],
                      type: cfg === null ? 'unknown' : cfg['SERVER_PREFERRED'],
                      difficulty: props === null ?
                          'unknown' : difficulty[props.difficulty],
                      gamemode: props === null ?
                          'unknown' : gamemode[props.gamemode]
                  };
                  cb(params);
              });
          });
      });
  }

  function loadWorldData(cb) {
      function onError(jqXHR, textStatus, errorThrown) {
          console.log(textStatus, errorThrown);
      }

      function onSuccess(data, status) {
          var worlds = [];

          console.log(data);
          console.log(status);
          if (status !== "success") {
              console.log(status, 'failed retrieving machines');
              return;
          }

          data.split("\n").forEach(function(line) {
              if (line.length > 0) {
                  console.log("line", line)
                  var server = JSON.parse(line);
                  if (server.type === "directory") {
                      worlds.push(server.name);
                  }
              }
          });

          var res = {};
          function tryEnd() {
              if (Object.keys(res).length === worlds.length) {
                  cb(null, res);
              }
          }

          worlds.forEach(function(world) {
              worldDetails(world, function (params) {
                  res[world] = params;
                  tryEnd();
              });
          });
      }

      $.ajax({
          'url': servers_loc,
          'cache': false,
          'dataType': "text",
          'error': onError,
          'success': onSuccess
      })

  }

  console.log(servers_loc);

  function onLoad() {
      var source   = $("#world-loading").html();
      var template = Handlebars.compile(source);
      var html = template({});
      $('div.games ul').append(html);
      loadWorldData(function (err, worlds) {
          //Remove the loading thing...
          var ul = $('div.games ul')[0];
          ul.innerHTML = '';

          //Now put in a pane for each world
          source   = $("#world-template").html();
          template = Handlebars.compile(source);
          Object.keys(worlds).sort().forEach(function (name) {
              params = worlds[name];
              html = template(params);
              $('div.games ul').append(html);
          });
      });
  }

  $(function() {
      onLoad();
      console.log('dom ready');
  });
</script>
<script id="world-template" type="text/x-handlebars-template">
<li id="{{name}}" class="glass">
  <table border=0 width=40% align=center>
    <tr>
      <td width=60% valign=top>
        <div class="title">{{name}}</div>
        <div>{{status}} {{#if ip}}at {{ip}}{{/if}}</div>
        <div>{{gamemode}}, {{difficulty}}</div>
        <div>{{type}} {{version}}</div>
      </td>
      <td><a href="{{map_index}}">
          <img width="200" height="200" src="{{thumbnail}}"
               onerror="this.style.display='none';"></a></td>
    </tr>
  </table>
</li>
</script>
<script id="world-loading" type="text/x-handlebars-template">
<li id="loading" class="glass">
  <h3>loading worlds...</h3>
</li>
</script>
</head>
<body>
<div class="header glass">
  <!--[if lt IE 9]>
    <div class="legacy-ie-fix"></div>
  <![endif]-->
  <h1>minecrab</h1>
</div>

<div class="games">
  <ul>
  </ul>
</div>

</body>
</html>
