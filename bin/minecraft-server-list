#!/usr/bin/env bash
# -*- mode: shell-script; fill-column: 80; -*-
#
# Copyright (c) 2013 Joyent Inc., All rights reserved.
#

#set -o xtrace
source $(dirname $0)/common.sh

usage() { echo "Usage: $0" 1>&2; exit 1; }

PATTERN="%-15s %-10s %s"
NAMES=()

RUNNING=$(sdc-listmachines --tag minecraft=* | \
    json -ga primaryIp state tags.minecraft)
if [[ $? -ne 0 ]]; then
    fatal "Unable to find running servers."
fi

MANTA=$(mls $SERVERS_LOCATION | tr -d '/' | xargs -n 1 echo "n/a offline")
if [[ $? -ne 0 ]]; then
        fatal "Unable to find offline servers."
fi

LIST="$RUNNING"
if [ ! -z "$RUNNING" ] && [ ! -z "$MANTA" ]; then
    LIST="$LIST\n"
fi
LIST="$LIST$MANTA"

printf "$PATTERN" "IP" "STATE" "NAME"
echo
echo -e "$LIST" | while read l; do
    IP=$(echo $l | cut -d ' ' -f 1)
    STATE=$(echo $l | cut -d ' ' -f 2)
    NAME=$(echo $l | cut -d ' ' -f 3)
    if [ $(contains "${NAMES[@]}" "$NAME") == "n" ]; then
	printf "$PATTERN" "$IP" "$STATE" "$NAME"
	echo
    fi
    NAMES+=("$NAME")
done
