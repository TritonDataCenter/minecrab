<html>
<head>
<link href='hammerhead.css' rel='stylesheet' type='text/css'>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
<script type="text/javascript">
  var worlds = [];
  var manta = document.location.protocol + '//' + document.location.hostname;
  var page = document.location.pathname;
  var user = page.split('/')[1];
  var servers_loc = manta + '/' + user + '/public/minecraft/servers/';

  function findIp(name, cb) {
      var user = page.split('/')[1];
      var url = servers_loc + name + '/ip';
      $.ajax({
          'url': url,
          'success': cb,
          'error': function () {
              cb(null);
          }
      });
  }

  console.log(servers_loc);

  $.ajax({
    url: servers_loc,
    cache: false,
    dataType: "text"
  })
  .error(function(jqXHR, textStatus, errorThrown) {
    console.log(textStatus, errorThrown);
  })
  .done(function(data, status) {
    console.log(data);
    console.log(status);
    if (status !== "success") {
      console.log(status, 'failed retrieving machines');
      return;
    }
    data.split("\n").forEach(function(line) {
      if (line.length > 0) {
        console.log("line", line)
        var server = JSON.parse(line);
        if (server.type === "directory") {
          worlds.push(server.name);
        }
      }
    });
    var source   = $("#world-template").html();
    var template = Handlebars.compile(source);
    worlds.forEach(function(world) {
      findIp(world, function (ip) {
        var status = ip ? 'Online' : 'Offline';
          var params = {
              name: world,
              ip: ip,
              status: status,
              map_index: servers_loc + world + '/map/view/index.html',
              thumbnail: servers_loc + world + '/map/view/render1/base.png'
          };
          var html   = template(params);
          $('div.games ul').append(html);
      });
    });
  });
  $(function() {
    console.log('dom ready');
  });
</script>
<script id="world-template" type="text/x-handlebars-template">
<li id="{{name}}" class="glass">
  <table border=0 width=70% align=center>
    <tr>
      <td width=60% valign=top>
	<div class="title">{{name}}</div>
	<div>{{status}}</div>
	<div>{{ip}}</div>
      </td>
      <td><a href="{{map_index}}">
	  <img width="200" height="200" src="{{thumbnail}}"
	       onerror="this.style.display='none';"></a></td>
    </tr>
  </table>
</li>
</script>
</head>
<body>
<div class="header glass">
  <!--[if lt IE 9]>
    <div class="legacy-ie-fix"></div>
  <![endif]-->
  <h1>miner</h1>
</div>

<div class="games">
  <ul>
  </ul>
</div>

</body>
</html>
