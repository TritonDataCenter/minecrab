#!/usr/bin/env bash
# -*- mode: shell-script; fill-column: 80; -*-
#
# Copyright (c) 2013 Joyent Inc., All rights reserved.
#


source $(dirname $0)/common.sh

usage() { echo "Usage: $0 [server-name]" 1>&2; exit 1; }

if [ "$#" -ne 1 ]; then
    usage
fi

SERVERNAME="$1"

IMAGEID=17c98640-1fdb-11e3-bf51-3708ce78e75a
#	{
#		"id": "17c98640-1fdb-11e3-bf51-3708ce78e75a",
#		"name": "base64",
#		"version": "13.2.1",
#		"os": "smartos",
#		"requirements": {},
#		"type": "smartmachine",
#		"description": "A 64-bit SmartOS image with just essential packages installed. Ideal for users who are comfortable with setting up their own environment and tools.",
#		"urn": "sdc:sdc:base64:13.2.1"
#	}

PACKAGENAME=g3-standard-4-smartos-image-creation
#	{
#		"name": "g3-standard-4-smartos-image-creation",
#		"memory": 4096,
#		"disk": 134144,
#		"swap": 8192,
#		"vcpus": 0,
#		"default": "false",
#		"id": "9c1948c0-0c37-11e3-be34-5780f9789210",
#		"version": "1.0.0",
#		"description": "4GB RAM, 1 CPUs and bursting, and 131GB Disk. Required for Image Creation.",
#		"group": "Image Creation"
#	}

# Check if $SERVERNAME already exists
# TODO

if [[ $(sdc-listmachines --tag "minecraft=${SERVERNAME}") != "[]" ]] ; then
	fatal "${SERVERNAME} already exists. Choose another name."
fi

echo -n "Creating ${SERVERNAME}"
SERVERID=$(sdc-createmachine	--dataset $IMAGEID \
								--package $PACKAGENAME \
								--tag "minecraft=${SERVERNAME}" | json id)
if [ -z $SERVERID ] ; then 
	fatal "Can't provision."
fi

while [[ $(sdc-getmachine $SERVERID | json state) ==  "provisioning" ]]
	do
		echo -n "."
		sleep 1
	done

echo "done"


