<html>
<head>
<link href='hammerhead.css' rel='stylesheet' type='text/css'>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
<script>
  var worlds = [];
  var page = '/Joyent_Dev/public/minecraft/index.html';
  var manta = 'http://us-east.manta.joyent.com';
  var user = page.split('/')[1];
  function findIp(name, cb) {
      var user = page.split('/')[1];
      var url = manta + '/' + user + '/public/minecraft/' + name + '/ip';
      $.ajax({
          'url': url,
          'success': cb,
          'error': function () {
              cb(null);
          }
      });
  }
  $.ajax({
    url: "http://us-east.manta.joyent.com/Joyent_Dev/public/minecraft/",
    cache: false,
    dataType: "text"
  })
  .error(function(jqXHR, textStatus, errorThrown) {
    console.log(textStatus, errorThrown);
  })
  .done(function(data, status) {
    console.log(data);
    console.log(status);
    if (status !== "success") {
      console.log(status, 'failed retrieving machines');
      return;
    }
    data.split("\n").forEach(function(line) {
      if (line.length > 0) {
        console.log("line", line)
        var server = JSON.parse(line);
        if (server.type === "directory") {
          worlds.push(server.name);
        }
      }
    });
    var source   = $("#world-template").html();
    var template = Handlebars.compile(source);
    worlds.forEach(function(world) {
      console.log('rendering', world);
      findIp(name, function (ip) {
          var params = {name: world, ip: ip};
          console.log(params);
          var html   = template(params);
          $('div.games ul').append(html);
      });
    });
  });
  $(function() {
    console.log('dom ready');
  });
</script>
<script id="world-template" type="text/x-handlebars-template">
<li id="{{name}}" class="glass">
  <div>
    <div class="title">{{name}}</div>
    <div>Online</div>
    <div>{{ip}}</div>
    <a href="https://us-east.manta.joyent.com/Joyent_Dev/public/minecraft/{{name}}/map/view/index.html">
      <div class="map"></div>
    </a>
  </div>
</li>
</script>
</head>
<body>
<div class="header glass">
  <!--[if lt IE 9]>
    <div class="legacy-ie-fix"></div>
  <![endif]-->
  <h1>miner</h1>
</div>

<div class="games">
  <ul>
  </ul>
</div>

</body>
</html>
