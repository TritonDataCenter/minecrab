#!/usr/bin/env bash
# -*- mode: shell-script; fill-column: 80; -*-
#
# Copyright (c) 2013 Joyent Inc., All rights reserved.
#

source $(dirname $0)/common.sh

usage() { echo "Usage: $0 <server-name>" 1>&2; exit 1; }

if [ "$#" -ne 1 ]; then
    usage
fi

SERVER_NAME=$1

DATA=$(sdc-listmachines --tag minecraft=$SERVER_NAME | json -ga)

if [ -z "$DATA" ]; then
    fatal "Unable to find running $SERVER_NAME server."
fi

ID=$(echo $DATA | json id)
NAME=$(echo $DATA | json name)
IMAGE=$(echo $DATA | json image)
MEMORY=$(echo $DATA | json memory)
DISK=$(echo $DATA | json disk)
DATASET=$(echo $DATA | json dataset)
IP=$(echo $DATA | json primaryIp)
MAP_IN_MANTA="$MANTA_LOCATION/$SERVER_NAME/map/view/index.html"
MAP="http://us-east.manta.joyent.com/$MANTA_LOCATION/$SERVER_NAME/map/view/index.html"
MAP_FOUND=$(mls $MAP_IN_MANTA 2>/dev/null)
if [ -z "$MAP_FOUND" ]; then
    MAP="(not generated)"
fi
MANTA="$MANTA_LOCATION/$SERVER_NAME/server/world.tar.gz"

cat - <<EOF
id:      $ID
name:    $NAME
image:   $IMAGE
memory:  $MEMORY mb
disk:    $DISK gb
dataset: $DATASET
ip addr: $IP
map:     $MAP
manta:   $MANTA
EOF
